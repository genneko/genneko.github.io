<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0">
  <title>WireGuard on FreeBSD Quick Look: Testing VPN in Jail Network - genneko</title>
  <meta property="og:title" content="WireGuard on FreeBSD Quick Look: Testing VPN in Jail Network - genneko" />
  <meta name="twitter:title" content="WireGuard on FreeBSD Quick Look: Testing VPN in Jail Network - genneko" />
  <meta name="description" content="WireGuard is a new VPN application which focuses on simplicity thus security and speed. Although it was initially developed as a Linux kernel feature, now it has a userspace implementation in Go and binary packages are available for FreeBSD.
I used this weekend to have a quick look at it on FreeBSD 12.0.
This time I focused on site-to-site VPN setup. Maybe I will try remote-access VPN configuration in the near future.">
  <meta property="og:description" content="WireGuard is a new VPN application which focuses on simplicity thus security and speed. Although it was initially developed as a Linux kernel feature, now it has a userspace implementation in Go and binary packages are available for FreeBSD.
I used this weekend to have a quick look at it on FreeBSD 12.0.
This time I focused on site-to-site VPN setup. Maybe I will try remote-access VPN configuration in the near future.">
  <meta name="twitter:description" content="WireGuard is a new VPN application which focuses on simplicity thus security and speed. Although it was initially developed as a Linux kernel feature, now it has a userspace implementation in Go and â€¦">
  <meta name="author" content="genneko"/>
  <meta property="og:site_name" content="genneko" />
  <meta property="og:url" content="https://genneko.github.io/playing-with-bsd/networking/freebsd-wireguard-quicklook/" />
  <meta property="og:type" content="article" />
  <meta name="twitter:card" content="summary" />
  <meta name="generator" content="Hugo 0.68.3" />

  <link rel="stylesheet" href="https://genneko.github.io/css/style.css" media="all" />
  <link rel="stylesheet" href="https://genneko.github.io/css/syntax.css" media="all" />
  <link rel="stylesheet" href="https://genneko.github.io/css/custom.css" media="all" />

  <script src="https://genneko.github.io/js/script.js"></script>
  <script src="https://genneko.github.io/js/custom.js"></script>
  <script defer src="https://genneko.github.io/js/fontawesome.js"></script>
</head>

<body>

<header class="site-header">
  <nav class="site-navi">
    <img class="site-icon" src="https://genneko.github.io/images/genneko-icon.png">
    <h1 class="site-title"><a href="https://genneko.github.io/">genneko</a></h1>
    <ul class="site-navi-items">
      <li class="site-navi-item-playing-with-bsd"><a href="https://genneko.github.io/playing-with-bsd/" title="Playing with BSD">Playing with BSD</a></li>
      <li class="site-navi-item-tags"><a href="https://genneko.github.io/tags/" title="Tags">Tags</a></li>
      <li class="site-navi-item-archives"><a href="https://genneko.github.io/archives/" title="Archives">Archives</a></li>
      <li class="site-navi-item-about"><a href="https://genneko.github.io/about/" title="About">About</a></li>
    </ul>
  </nav>
</header>
<hr class="site-header-bottom">


  <div class="main" role="main">
    <article class="article">
      
      
      <h1 class="article-title">WireGuard on FreeBSD Quick Look: Testing VPN in Jail Network</h1>
      
      <hr class="article-title-bottom">
      <ul class="article-meta">
        <li class="article-meta-date"><time>2019-01-20</time>
        
        <span class="updated">Update: 2019-05-29</span>
        
        </li>
        <li class="article-meta-tags">
          <a href="https://genneko.github.io/tags/freebsd/">
            <i class="fas fa-tag"></i>
            freebsd
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="https://genneko.github.io/tags/network/">
            <i class="fas fa-tag"></i>
            network
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="https://genneko.github.io/tags/vpn/">
            <i class="fas fa-tag"></i>
            vpn
          </a>&nbsp;
        </li>
        <li class="article-meta-tags">
          <a href="https://genneko.github.io/tags/wireguard/">
            <i class="fas fa-tag"></i>
            wireguard
          </a>&nbsp;
        </li>
      </ul>
      
<aside class="toc">
  <nav id="TableOfContents">
  <ul>
    <li><a href="#prerequisite">Prerequisite</a></li>
    <li><a href="#site-to-site-configuration">Site-to-Site Configuration</a>
      <ul>
        <li><a href="#install-wireguard">Install WireGuard</a></li>
        <li><a href="#setup-manually">Setup Manually</a></li>
        <li><a href="#test-connectivity-and-encryption">Test Connectivity and Encryption</a></li>
        <li><a href="#configure-wireguard-service-with-rcd">Configure WireGuard Service with rc.d</a></li>
      </ul>
    </li>
    <li><a href="#remote-access-host-to-site-configuration">Remote Access (Host-to-Site) Configuration</a>
      <ul>
        <li><a href="#change-settings">Change Settings</a></li>
        <li><a href="#test-and-monitor">Test and Monitor</a></li>
        <li><a href="#what-if-the-host-moves">What if the Host Moves</a></li>
      </ul>
    </li>
    <li><a href="#caveats">Caveats</a>
      <ul>
        <li><a href="#on-vnet-jails-wgx-cannot-be-destroyed-fixed">On VNET Jails, wgX cannot be destroyed (Fixed)</a></li>
        <li><a href="#kernel-panics-on-shutdown-seems-to-be-fixed-on-113-beta">Kernel panics on shutdown (Seems to be fixed on 11.3 BETA)</a></li>
        <li><a href="#rcd-script-leaves-two-processes-after-shutdown">rc.d script leaves two processes after shutdown</a></li>
      </ul>
    </li>
    <li><a href="#references">References</a></li>
    <li><a href="#revision-history">Revision History</a></li>
  </ul>
</nav>
</aside>
      <p><a href="https://www.wireguard.com">WireGuard</a> is a new VPN application which focuses on simplicity thus security and speed. Although it was initially developed as a Linux kernel feature, now it has a userspace implementation in Go and binary packages are available for FreeBSD.</p>
<p>I used this weekend to have a quick look at it on FreeBSD 12.0.<br>
This time I focused on site-to-site VPN setup. Maybe I will try remote-access VPN configuration in the near future.</p>
<p><em>NOTE: WireGuard is still in early stage of development. Go-implementation (wireguard-go) has no official release yet. Also testing network software on VNET jails might be a bit tricky in itself. This article just shows you what I did to see what it looked like.</em></p>
<p>2019-01-23: I tested remote-access configuration between FreeBSD and Android. A quick write-up is <a href="https://genneko.github.io/playing-with-bsd/networking/freebsd-wireguard-android">here</a>.</p>
<p>2019-01-26: Added a <a href="#remote-access-host-to-site-configuration">new section</a> on testing remote-access (host-to-site) by a roaming client.</p>
<h2 id="prerequisite">Prerequisite</h2>
<ul>
<li>FreeBSD 12.0/amd64</li>
<li>Generic kernel (finally with VIMAGE enabled)</li>
<li>Bash as an login shell on the host</li>
</ul>
<h2 id="site-to-site-configuration">Site-to-Site Configuration</h2>
<p>To play quickly with WireGuard, I built the following internal network made up with five VNET jails on a single FreeBSD host.</p>
<ul>
<li>r1 (Router forwarding packets between vpnr1 and vpnr2.</li>
<li>vpnr1 (VPN Router for the site 1)</li>
<li>vpnr2 (VPN Router for the site 2)</li>
<li>vpnh1 (Host on the site 1)</li>
<li>vpnh2 (Host on the site 2)</li>
</ul>
<pre style="line-height: 10pt"><code style="font-size: 9pt">                                 Site 1

                      vri1_vpnr1      vri1_vpnh1
       [Router(vpnr1)]o ------ (vri1br) ------ o[Host (vpnh1)]
     vi1_vpnr1 o |    192.168.1.1   192.168.1.11
   172.31.1.11 | o wg0
               |  \  192.168.222.1
            (vi1br)\
               |    \
   172.31.1.1  |     \
        vi1_r1 o      \
         [Router(r1)]  | WireGuard tunnel
        vi2_r1 o      /
   172.31.2.1  |     /
               |    /
            (vi2br)/
               |  /
   172.31.2.11 | /   192.168.222.2
               | o wg0
     vi2_vpnr2 o |    192.168.2.1   192.168.2.11
       [Router(vpnr2)]o ------ (vri2br) ------ o[Host (vpnh2)]
                      vri2_vpnr2      vri2_vpnh2

                                 Site 2
</code></pre>
<p>In this configuration,  jail r1 acts as a central router which crudely emulates a public network and is to be used as a monitoring post running tcpdump, while jail vpnr1 and vpnr2 are routers on private sites and remaining two (vpnh1 and vpnh2) are hosts on the private sites.</p>
<p>I planned to run WireGuard on vpnr1 and vpnr2 and build a VPN tunnel between site1 and site2.</p>
<p>For details on jails configuration, please refer to <a href="https://genneko.github.io/playing-with-bsd/system/learning-notes-on-jails/#isolated-network-configuration">another post</a>.<br>
The following sections assume that all five jails are up and running.</p>
<h3 id="install-wireguard">Install WireGuard</h3>
<p>Because the jails in the above configuration cannot access network outside of the host system, <code>pkg install</code> cannot be used to install WireGuard on them. Instead I used <code>pkg add</code> to install the package files downloaded with <code>pkg fetch</code>.</p>
<ol>
<li>
<p>Download package files on the host.<br>
With -d option, <code>pkg fetch</code> downloads the specified package plus its dependencies.<br>
Downloaded files are stored in the host&rsquo;s /var/cache/pkg.</p>
<pre><code>sudo pkg fetch -d wireguard
</code></pre></li>
<li>
<p>Make the downloaded package files available to jails.<br>
Although you can simply copy the files to jails&rsquo; filesystem, nullfs mount /var/cache/pkg on jails looks much easier.<br>
The following line in /etc/jail.conf achieves this.<br>
When you start jails, the host&rsquo;s /var/cache/pkg is mounted on each jail&rsquo;s /mnt directory.<br>
[/etc/jail.conf]</p>
<pre><code>...
mount = &quot;/var/cache/pkg /vm/${name}/mnt nullfs ro 0 0&quot;;
...
</code></pre></li>
<li>
<p>Install the package on jails from the host.<br>
The filepath on the command line is the one viewed from jails not the host.</p>
<pre><code>for jail in vpnr1 vpnr2 vpnh2; do
        sudo pkg -j $jail add /mnt/wireguard-0.0.20181218.txz
done
</code></pre></li>
</ol>
<h3 id="setup-manually">Setup Manually</h3>
<p>First I tried to manually setup WireGuard by roughly following <a href="https://www.wireguard.com/quickstart/">Quick Start</a> guide on the WireGuard website.</p>
<ol>
<li>
<p>Create private/public key pairs.<br>
[vpnr1]</p>
<pre><code>mkdir ~/wg
cd ~/wg
wg genkey &gt; private
wg pubkey &lt; private &gt; public
</code></pre><p>[vpnr2]</p>
<pre><code>mkdir ~/wg
cd ~/wg
wg genkey &gt; private
wg pubkey &lt; private &gt; public
</code></pre></li>
<li>
<p>Make configuration files.<br>
[vpnr1:~/wg/wg0.conf]</p>
<pre><code>[Interface]
PrivateKey = aGi8VucdQG9h9sWHV2jZT5JmAXZpyadTPJlV4BS1124=
ListenPort = 51820
   
[Peer]
PublicKey = l/bRgqGEAzNtVq9JI3GyYnhFgCRXLNpakPxemH3mrA8=
AllowedIPs = 192.168.222.2/32, 192.168.2.0/24
Endpoint = 172.31.2.11:51820
</code></pre><p>[vpnr2:~/wg/wg0.conf]</p>
<pre><code>[Interface]
PrivateKey = 8DlDYe7fBA/vCahHGEBj+6DXs111eFiAIGEnDoKtckA=
ListenPort = 51820
   
[Peer]
PublicKey = uoYkPm6lHnxF5T31lD5LB3OGM8/a4eKyUEYcJm5SXXQ=
AllowedIPs = 192.168.222.1/32, 192.168.1.0/24
Endpoint = 172.31.1.11:51820
</code></pre><p>Interface section defines a local WireGuard interface.<br>
PrivateKey is a private key string generated by <code>wg genkey</code> on the local system. It is stored in ~/wg/private.<br>
ListenPort is a UDP port number on which the local system listens on.<br>
Peer section defines a remote WireGuard nodes.<br>
PublicKey is a public key string for a remote system. It is stored in ~/wg/public on the remote system.<br>
AllowedIPs specifies IP address ranges which is allowed to pass through this WireGuard tunnel.<br>
Endpoint is an external IP address/UDP port of the remote system which is used to establish VPN connection.</p>
</li>
<li>
<p>Create WireGuard interfaces.
To create WireGuard interface on FreeBSD, you need to run userspace wireguard-go program.<br>
Once an interface was created, you can assign IP address on the interface, add routes to remote network through the interface and apply WireGuard configuration to the interface.<br>
[vpnr1]</p>
<pre><code>wireguard-go wg0
ifconfig wg0 inet 192.168.222.1 192.168.222.1
route add 192.168.222.2/32 -interface wg0
route add 192.168.2.0/24 -interface wg0
wg setconf wg0 ~/wg/wg0.conf
ifconfig wg0 down up
</code></pre><p>[vpnr2]</p>
<pre><code>wireguard-go wg0
ifconfig wg0 inet 192.168.222.2 192.168.222.2
route add 192.168.222.1/32 -interface wg0
route add 192.168.1.0/24 -interface wg0
wg setconf wg0 ~/wg/wg0.conf
ifconfig wg0 down up
</code></pre><p><strong>NOTE</strong><br>
In my environment, wg0 interface didn&rsquo;t work without <code>ifconfig wg0 down</code> before <code>ifconfig wg0 up</code>.<br>
By &ldquo;didn&rsquo;t work&rdquo;, I mean that UDP sockets were not created.</p>
</li>
<li>
<p>Confirm configurations.<br>
[vpnr1]</p>
<pre><code>netstat -rnfinet
Routing tables
   
Internet:
Destination        Gateway            Flags     Netif Expire
default            172.31.1.1         UGS    vi1_vpnr
127.0.0.1          link#1             UH          lo0
172.31.1.0/24      link#2             U      vi1_vpnr
172.31.1.11        link#2             UHS         lo0
192.168.1.0/24     link#3             U      vri1_vpn
192.168.1.1        link#3             UHS         lo0
192.168.2.0/24     wg0                US          wg0
192.168.222.1      link#4             UH          wg0
192.168.222.2/32   wg0                US          wg0
</code></pre><p>[vpnr1]</p>
<pre><code>ifconfig wg0
wg0: flags=8051&lt;UP,POINTOPOINT,RUNNING,MULTICAST&gt; metric 0 mtu 1420
        options=80000&lt;LINKSTATE&gt;
        inet 192.168.222.1 --&gt; 192.168.222.1 netmask 0xffffff00
        inet6 fe80::5c71:f2c9:7123:67ad%wg0 prefixlen 64 scopeid 0x4
        groups: tun
        nd6 options=21&lt;PERFORMNUD,AUTO_LINKLOCAL&gt;
        Opened by PID 6703
</code></pre><p>[vpnr1]</p>
<pre><code>wg show
interface: wg0
  public key: uoYkPm6lHnxF5T31lD5LB3OGM8/a4eKyUEYcJm5SXXQ=
  private key: (hidden)
  listening port: 51820
   
peer: l/bRgqGEAzNtVq9JI3GyYnhFgCRXLNpakPxemH3mrA8=
  endpoint: 172.31.2.11:51820
  allowed ips: 192.168.2.0/24, 192.168.222.2/32
</code></pre></li>
</ol>
<h3 id="test-connectivity-and-encryption">Test Connectivity and Encryption</h3>
<p>Once the configuration was done, I tested site-to-site connectivity by running ping between routers and hosts.<br>
I was also monitoring packets on the intermediate router (r1) and site2 router (vpnr2) with tcpdump in order to see if the packets are encrypted.</p>
<h4 id="packets-outside-of-the-tunnel">Packets outside of the Tunnel</h4>
<p>Ping packets from the external address of the router on site 1 (vpnr1: 172.31.1.11) to the router on site 2 (vpnr2: 172.31.2.11) were expected to be unencrypted.</p>
<p>[vpnr1]</p>
<pre><code>ping -c1 -p 504c41494e 172.31.2.11
PATTERN: 0x504c41494e
PING 172.31.2.11 (172.31.2.11): 56 data bytes
64 bytes from 172.31.2.11: icmp_seq=0 ttl=64 time=0.147 ms
...
</code></pre><p>[r1]</p>
<pre><code>tcpdump -vln -X -i vi1_r1
09:34:20.976217 IP (tos 0x0, ttl 64, id 8502, offset 0, flags [none], proto ICMP (1), length 84)
    172.31.1.11 &gt; 172.31.2.11: ICMP echo request, id 39437, seq 0, length 64
        0x0000:  4500 0054 2136 0000 4001 fe1e ac1f 010b  E..T!6..@.......
        0x0010:  ac1f 020b 0800 d9e7 9a0d 0000 5c44 409c  ............\D@.
        0x0020:  000e e51e 504c 4149 4e50 4c41 494e 504c  ....PLAINPLAINPL
        0x0030:  4149 4e50 4c41 494e 504c 4149 4e50 4c41  AINPLAINPLAINPLA
        0x0040:  494e 504c 4149 4e50 4c41 494e 504c 4149  INPLAINPLAINPLAI
        0x0050:  4e50 4c41                                NPLA
09:34:20.976276 IP (tos 0x0, ttl 63, id 50381, offset 0, flags [none], proto ICMP (1), length 84)
    172.31.2.11 &gt; 172.31.1.11: ICMP echo reply, id 39437, seq 0, length 64
        0x0000:  4500 0054 c4cd 0000 3f01 5b87 ac1f 020b  E..T....?.[.....
        0x0010:  ac1f 010b 0000 e1e7 9a0d 0000 5c44 409c  ............\D@.
        0x0020:  000e e51e 504c 4149 4e50 4c41 494e 504c  ....PLAINPLAINPL
        0x0030:  4149 4e50 4c41 494e 504c 4149 4e50 4c41  AINPLAINPLAINPLA
        0x0040:  494e 504c 4149 4e50 4c41 494e 504c 4149  INPLAINPLAINPLAI
        0x0050:  4e50 4c41                                NPLA
</code></pre><p>You can see the embedded pattern &lsquo;PLAIN&rsquo; so they are not encrypted.</p>
<h4 id="packets-in-the-tunnel">Packets in the Tunnel</h4>
<p>Ping packets from the host on site 1 (vpnh1) to the host on site 2 (vpnh2) were to be encapsulated/encrypted on vpnr1 and to be decapsulated/decrypted on vpnr2.</p>
<p>[vpnh1]</p>
<pre><code>ping -c1 -p 504c41494e 192.168.2.11
PATTERN: 0x504c41494e
PING 192.168.2.11 (192.168.2.11): 56 data bytes
64 bytes from 192.168.2.11: icmp_seq=0 ttl=62 time=8.150 ms
...
</code></pre><p>[r1]</p>
<pre><code>tcpdump -vln -X -i vi1_r1
02:16:56.444934 IP (tos 0x0, ttl 64, id 35847, offset 0, flags [none], proto UDP (17), length 156)
    172.31.1.11.51820 &gt; 172.31.2.11.51820: UDP, length 128
        0x0000:  4500 009c 8c07 0000 4011 92f5 ac1f 010b  E.......@.......
        0x0010:  ac1f 020b ca6c ca6c 0088 d7c4 0400 0000  .....l.l........
        0x0020:  bbe8 7f40 0200 0000 0000 0000 6849 62b9  ...@........hIb.
        0x0030:  3d51 ffdb 158a b426 f622 6599 be69 9e82  =Q.....&amp;.&quot;e..i..
        0x0040:  981a 1d2c 15c7 c81f 61ed 27f1 86f3 2048  ...,....a.'....H
        0x0050:  ef82 0570 80cb 3444 3c41 add9 e40c c963  ...p..4D&lt;A.....c
        0x0060:  ae2b faac ef78 7757 2d3c 44b1 3ef5 871f  .+...xwW-&lt;D.&gt;...
        0x0070:  bc06 5d10 b727 0ce1 4e33 8c01 47b0 da66  ..]..'..N3..G..f
        0x0080:  79c7 f861 8266 2bfb 3b4f 9151 c192 ebc6  y..a.f+.;O.Q....
        0x0090:  ed64 a9e1 a5e2 5fd8 51f1 bad2            .d...._.Q...
02:16:56.449331 IP (tos 0x0, ttl 63, id 23891, offset 0, flags [none], proto UDP (17), length 156)
    172.31.2.11.51820 &gt; 172.31.1.11.51820: UDP, length 128
        0x0000:  4500 009c 5d53 0000 3f11 c2a9 ac1f 020b  E...]S..?.......
        0x0010:  ac1f 010b ca6c ca6c 0088 d217 0400 0000  .....l.l........
        0x0020:  d272 6289 0100 0000 0000 0000 28bb 220e  .rb.........(.&quot;.
        0x0030:  b8ab b371 db34 9421 bf6a b713 91e9 d15e  ...q.4.!.j.....^
        0x0040:  fdaf 721e bc41 b1be c302 9914 db9f 59c2  ..r..A........Y.
        0x0050:  c0a8 6428 b103 06b1 7cad 897c 8359 6f91  ..d(....|..|.Yo.
        0x0060:  95aa 2481 c80b 1bd3 3fb1 6186 f123 036f  ..$.....?.a..#.o
        0x0070:  f779 3ac9 10f9 df02 75fa e89e ebe5 9bd6  .y:.....u.......
        0x0080:  506f 4b5e 5228 db0e a4ca bd9e e131 c264  PoK^R(.......1.d
        0x0090:  8f1c 0cd5 83f1 d423 04a2 b99c            .......#....
</code></pre><p>On the intermediate router (r1), the Ping packets were encapsulated in those UDP packets sent between port 51820 of vpnr1 and vpnr2. They were WireGuard tunnel packets and their contents were apparently encrypted.</p>
<p>[vpnr2]</p>
<pre><code>tcpdump -vln -X -i vi2_vpnr2
02:16:56.444955 IP (tos 0x0, ttl 63, id 35847, offset 0, flags [none], proto UDP (17), length 156)
    172.31.1.11.51820 &gt; 172.31.2.11.51820: UDP, length 128
        0x0000:  4500 009c 8c07 0000 3f11 93f5 ac1f 010b  E.......?.......
        0x0010:  ac1f 020b ca6c ca6c 0088 d7c4 0400 0000  .....l.l........
        0x0020:  bbe8 7f40 0200 0000 0000 0000 6849 62b9  ...@........hIb.
        0x0030:  3d51 ffdb 158a b426 f622 6599 be69 9e82  =Q.....&amp;.&quot;e..i..
        0x0040:  981a 1d2c 15c7 c81f 61ed 27f1 86f3 2048  ...,....a.'....H
        0x0050:  ef82 0570 80cb 3444 3c41 add9 e40c c963  ...p..4D&lt;A.....c
        0x0060:  ae2b faac ef78 7757 2d3c 44b1 3ef5 871f  .+...xwW-&lt;D.&gt;...
        0x0070:  bc06 5d10 b727 0ce1 4e33 8c01 47b0 da66  ..]..'..N3..G..f
        0x0080:  79c7 f861 8266 2bfb 3b4f 9151 c192 ebc6  y..a.f+.;O.Q....
        0x0090:  ed64 a9e1 a5e2 5fd8 51f1 bad2            .d...._.Q...
02:16:56.449308 IP (tos 0x0, ttl 64, id 23891, offset 0, flags [none], proto UDP (17), length 156)
    172.31.2.11.51820 &gt; 172.31.1.11.51820: UDP, length 128
        0x0000:  4500 009c 5d53 0000 4011 c1a9 ac1f 020b  E...]S..@.......
        0x0010:  ac1f 010b ca6c ca6c 0088 d217 0400 0000  .....l.l........
        0x0020:  d272 6289 0100 0000 0000 0000 28bb 220e  .rb.........(.&quot;.
        0x0030:  b8ab b371 db34 9421 bf6a b713 91e9 d15e  ...q.4.!.j.....^
        0x0040:  fdaf 721e bc41 b1be c302 9914 db9f 59c2  ..r..A........Y.
        0x0050:  c0a8 6428 b103 06b1 7cad 897c 8359 6f91  ..d(....|..|.Yo.
        0x0060:  95aa 2481 c80b 1bd3 3fb1 6186 f123 036f  ..$.....?.a..#.o
        0x0070:  f779 3ac9 10f9 df02 75fa e89e ebe5 9bd6  .y:.....u.......
        0x0080:  506f 4b5e 5228 db0e a4ca bd9e e131 c264  PoK^R(.......1.d
        0x0090:  8f1c 0cd5 83f1 d423 04a2 b99c            .......#....

tcpdump -vln -X -i vri2_vpnr2
02:16:56.448996 IP (tos 0x0, ttl 62, id 4830, offset 0, flags [none], proto ICMP (1), length 84)
    192.168.1.11 &gt; 192.168.2.11: ICMP echo request, id 12830, seq 0, length 64
        0x0000:  4500 0054 12de 0000 3e01 e564 c0a8 010b  E..T....&gt;..d....
        0x0010:  c0a8 020b 0800 c426 321e 0000 5c43 da18  .......&amp;2...\C..
        0x0020:  0006 c95b 504c 4149 4e50 4c41 494e 504c  ...[PLAINPLAINPL
        0x0030:  4149 4e50 4c41 494e 504c 4149 4e50 4c41  AINPLAINPLAINPLA
        0x0040:  494e 504c 4149 4e50 4c41 494e 504c 4149  INPLAINPLAINPLAI
        0x0050:  4e50 4c41                                NPLA
02:16:56.449059 IP (tos 0x0, ttl 64, id 2573, offset 0, flags [none], proto ICMP (1), length 84)
    192.168.2.11 &gt; 192.168.1.11: ICMP echo reply, id 12830, seq 0, length 64
        0x0000:  4500 0054 0a0d 0000 4001 ec35 c0a8 020b  E..T....@..5....
        0x0010:  c0a8 010b 0000 cc26 321e 0000 5c43 da18  .......&amp;2...\C..
        0x0020:  0006 c95b 504c 4149 4e50 4c41 494e 504c  ...[PLAINPLAINPL
        0x0030:  4149 4e50 4c41 494e 504c 4149 4e50 4c41  AINPLAINPLAINPLA
        0x0040:  494e 504c 4149 4e50 4c41 494e 504c 4149  INPLAINPLAINPLAI
        0x0050:  4e50 4c41                                NPLA
</code></pre><p>On the router on site 2 (vpnr2), the Ping packets were encapsulated/encrypted on the external interface (vi2_vpnr2) but not so on the internal interface (vri2_vpnr2).</p>
<h3 id="configure-wireguard-service-with-rcd">Configure WireGuard Service with rc.d</h3>
<p>Now I know how to configure WireGuard on FreeBSD systems.<br>
But to use it in the real world, I had to script the procedures in some way for automatic startup/shutdown of the tunnel.</p>
<p>Then I realized that there&rsquo;s already an rc.d script /usr/local/etc/rc.d/wireguard which came with the wireguard package.</p>
<p>The script uses wg-quick bash script to setup/shutdown tunnels. Its configuration is simple as follows. I only added Address parameter which specifies the IP address set on the WireGuard interface.</p>
<p>wg-quick script reads the configutation and automatically creates a WireGuard interface, assign IP address (Address) on the interface and adds routes to remote network (AllowedIPs) through the interface.</p>
<p>vpnr1 [/usr/local/etc/wireguard/wg0.conf]</p>
<pre><code>[Interface]
Address = 192.168.222.1/32
PrivateKey = aGi8VucdQG9h9sWHV2jZT5JmAXZpyadTPJlV4BS1124=
ListenPort = 51820

[Peer]
PublicKey = l/bRgqGEAzNtVq9JI3GyYnhFgCRXLNpakPxemH3mrA8=
AllowedIPs = 192.168.222.2/32, 192.168.2.0/24
Endpoint = 172.31.2.11:51820
</code></pre><p>vpnr2 [/usr/local/etc/wireguard/wg0.conf]</p>
<pre><code>[Interface]
Address = 192.168.222.2/32
PrivateKey = 8DlDYe7fBA/vCahHGEBj+6DXs111eFiAIGEnDoKtckA=
ListenPort = 51820

[Peer]
PublicKey = uoYkPm6lHnxF5T31lD5LB3OGM8/a4eKyUEYcJm5SXXQ=
AllowedIPs = 192.168.222.1/32, 192.168.1.0/24
Endpoint = 172.31.1.11:51820
</code></pre><p>To enable and start WireGuard service, run the following commands on both vpnr1 and vpnr2.</p>
<pre><code>sysrc wireguard_enable=YES
sysrc wireguard_interfaces=&quot;wg0&quot;
service wireguard start
</code></pre><h2 id="remote-access-host-to-site-configuration">Remote Access (Host-to-Site) Configuration</h2>
<p>A few days later I also tried a remote access VPN configuration where the host vpnh2 connected to the router vpnr1 and its inner network (192.168.1.0/24).</p>
<p>The router vpnr2 ran WireGuard in the previous site-to-site example, but in the modified configuration it became an ordinary router/NAT box.</p>
<pre style="line-height: 10pt"><code style="font-size: 9pt">                                 Site 1

                      vri1_vpnr1      vri1_vpnh1
       [Router(vpnr1)]o ------ (vri1br) ------ o[Host (vpnh1)]
     vi1_vpnr1 o |    192.168.1.1   192.168.1.11
   172.31.1.11 | o wg0
               |  \  192.168.222.1
            (vi1br)\
               |    \
   172.31.1.1  |     \
        vi1_r1 o      \
         [Router(r1)]  WireGuard
        vi2_r1 o         tunnel
   172.31.2.1  |                \
               |                 \
            (vi2br)               \
               |                   \                     192.168.222.211
   172.31.2.11 |                    \----------------o wg0
               |                                     |
     vi2_vpnr2 o      192.168.2.1   192.168.2.11     |
       [Router(vpnr2)]o ------ (vri2br) ------ o[Host (vpnh2)]
                      vri2_vpnr2      vri2_vpnh2

                                 Site 2
</code></pre>
<p>NOTE: I also tested remote-access configuration using the WireGuard Android app. See <a href="https://genneko.github.io/playing-with-bsd/networking/freebsd-wireguard-android">this article</a> on this.</p>
<h3 id="change-settings">Change Settings</h3>
<p>Here is a summary of changes which I made to the site-to-site configuration.</p>
<ol>
<li>
<p>Reconfigure vpnr2 and make it a normal NAT router.<br>
[vpnr2:/etc/pf.conf]</p>
<pre><code>XIF = &quot;vi2_vpnr2&quot;
PRIVATENET = &quot;192.168.2.0/24&quot;
nat on $XIF inet from $PRIVATENET to any -&gt; ($XIF)
</code></pre><p>[vpnr2]</p>
<pre><code>service wireguard stop
sysrc wireguard_enable=&quot;NO&quot;
sysrc pf_enable=&quot;YES&quot;
service pf start
</code></pre></li>
<li>
<p>Configure WireGuard on vpnh2.<br>
[vpnh2]</p>
<pre><code>cd /usr/local/etc/wireguard
wg genkey &gt; private
wg pubkey &lt; private &gt; public
vi wg0.conf
</code></pre><p>[vpnh2:/usr/local/etc/wireguard/wg0.conf]</p>
<pre><code>[Interface]
Address = 192.168.222.211/32
PrivateKey = content of &lt;private&gt;
   
[Peer]
PublicKey = uoYkPm6lHnxF5T31lD5LB3OGM8/a4eKyUEYcJm5SXXQ=
AllowedIPs = 192.168.222.1/32, 192.168.1.0/24
Endpoint = 172.31.1.11:51820
</code></pre><p>[vpnh2]</p>
<pre><code>sysrc wireguard_enable=&quot;YES&quot;
sysrc wireguard_interfaces=&quot;wg0&quot;
service wireguard start
</code></pre></li>
<li>
<p>Reconfigure vpnr1 to accept connection from vpnh2 instead of vpnr2.<br>
[vpnr1:/usr/local/etc/wireguard/wg0.conf]</p>
<pre><code>[Interface]
Address = 192.168.222.1/32
PrivateKey = aGi8VucdQG9h9sWHV2jZT5JmAXZpyadTPJlV4BS1124=
ListenPort = 51820
   
[Peer]
PublicKey = content of vpnh2's &lt;public&gt;
AllowedIPs = 192.168.222.211/32
</code></pre><p>[vpnr1]</p>
<pre><code>service wireguard stop
service wireguard start
</code></pre></li>
</ol>
<h3 id="test-and-monitor">Test and Monitor</h3>
<p>Let&rsquo;s test connectivity with ping from vpnh2 to vpnh1.</p>
<ol>
<li>
<p>Start tcpdump on the intermediate router r1 to monitor WireGuard packets.<br>
[r1]</p>
<pre><code>tcpdump -ln -i vi1_r1
</code></pre></li>
<li>
<p>On the WireGuard client host vpnh2, start ping to the host vpnh1 (192.168.1.11) which is on the private network behind the remote VPN router vpnr1.<br>
[vpnh2]</p>
<pre><code>ping 192.168.1.11
PING 192.168.1.11 (192.168.1.11): 56 data bytes
64 bytes from 192.168.1.11: icmp_seq=0 ttl=63 time=1.669 ms
64 bytes from 192.168.1.11: icmp_seq=1 ttl=63 time=0.903 ms
...
</code></pre></li>
<li>
<p>Check r1&rsquo;s console.<br>
You can see WireGuard&rsquo;s UDP packets between vpnr1 and vpnr2.<br>
[r1]</p>
<pre><code>08:08:42.810690 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:08:42.811823 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
08:08:43.838714 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:08:43.840446 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
...
</code></pre><p>Why vnpr2? Isn&rsquo;t it vpnh2?<br>
It&rsquo;s because vpnh2&rsquo;s address (192.168.2.11) is tranlated to the external address of vpnr2 (172.31.2.11) by vpnr2&rsquo;s NAT function.<br>
This can be confirmed by running tcpdump on vpnr2&rsquo;s external and internal interfaces.</p>
</li>
<li>
<p>Monitor WireGuard packets on NAT box vpnr2.<br>
On the internal vri2_vpnr2 interface, WireGuard packets have vpnh2&rsquo;s address 192.168.2.11 for its source or destination.<br>
But on the external vi2_vpnr2 interface, the vpnh2&rsquo;s address is tranlated to vi2_vpnr2 interface&rsquo;s adddress.<br>
[vpnr2]</p>
<pre><code>tcpdump -ln -i vri2_vpnr2
08:13:53.948608 IP 192.168.2.11.51820 &gt; 172.31.1.11.51820: UDP, length 128
08:13:53.949736 IP 172.31.1.11.51820 &gt; 192.168.2.11.51820: UDP, length 128
08:13:55.011758 IP 192.168.2.11.51820 &gt; 172.31.1.11.51820: UDP, length 128
08:13:55.012736 IP 172.31.1.11.51820 &gt; 192.168.2.11.51820: UDP, length 128
^C
tcpdump -ln -i vi2_vpnr2
08:14:03.258349 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:14:03.258977 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
08:14:04.331344 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:14:04.333282 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
^C
</code></pre></li>
<li>
<p>You can also see the remote VPN router vpnr1 is decrypting/decapsulating incoming packets and vise versa to outgoing packets.<br>
[vpnr1]</p>
<pre><code>tcpdump -ln -i vi1_vpnr1
08:16:35.061792 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:16:35.062845 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
08:16:36.079824 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:16:36.080811 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
^C
tcpdump -ln -i vri1_vpnr1
08:16:43.379386 IP 192.168.222.211 &gt; 192.168.1.11: ICMP echo request, id 64096, seq 522, length 64
08:16:43.379533 IP 192.168.1.11 &gt; 192.168.222.211: ICMP echo reply, id 64096, seq 522, length 64
08:16:44.419530 IP 192.168.222.211 &gt; 192.168.1.11: ICMP echo request, id 64096, seq 523, length 64
08:16:44.419601 IP 192.168.1.11 &gt; 192.168.222.211: ICMP echo reply, id 64096, seq 523, length 64
^C
</code></pre></li>
</ol>
<h3 id="what-if-the-host-moves">What if the Host Moves</h3>
<p>Now that basic connectivity was confirmed, next I went one step further to see what happened if the client vpnh2 moved to other subnet.</p>
<ol>
<li>
<p>To quickly let vpnh2 go out and back, I made the following small shell scripts on the host.<br>
[host:goout.sh]</p>
<pre><code>#!/bin/sh
ngctl rmhook vri2_vpnh2: ether
ngctl connect vi2br: vri2_vpnh2: link2 ether
jexec vpnh2 ifconfig vri2_vpnh2 inet 172.31.2.111/24
jexec vpnh2 route add default 172.31.2.1
</code></pre><p>[host:goback.sh]</p>
<pre><code>#!/bin/sh
ngctl rmhook vri2_vpnh2: ether
ngctl connect vri2br: vri2_vpnh2: link2 ether
jexec vpnh2 ifconfig vri2_vpnh2 inet 192.168.2.11/24
jexec vpnh2 route add default 192.168.2.1
</code></pre></li>
<li>
<p>Assume ping from vpnh2 to vpnh1 is still ongoing.<br>
[vpnh2]</p>
<pre><code>...
64 bytes from 192.168.1.11: icmp_seq=1330 ttl=63 time=1.872 ms
</code></pre><p>[r1]</p>
<pre><code>...
08:30:43.318780 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:30:43.319744 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
</code></pre></li>
<li>
<p>Move vpnh2 to 172.31.2.0/24 subnet (outside of vpnr2). Its address was changed from 192.168.2.11 to 172.31.2.111 and its packets no longer went through NAT.<br>
[host]</p>
<pre><code>sudo sh ./goout.sh
</code></pre></li>
<li>
<p>See what happens.<br>
Source IP address of WireGuard packets were changed from 172.31.2.11 to 172.31.2.11 while vpnh2 was receiving ping responses continuously.<br>
[vpnh2]</p>
<pre><code>64 bytes from 192.168.1.11: icmp_seq=1331 ttl=63 time=1.908 ms
64 bytes from 192.168.1.11: icmp_seq=1332 ttl=63 time=0.731 ms
</code></pre><p>[r1]</p>
<pre><code>08:30:44.349088 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:30:44.349997 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
08:30:45.388243 IP 172.31.2.111.51820 &gt; 172.31.1.11.51820: UDP, length 128
08:30:45.388659 IP 172.31.1.11.51820 &gt; 172.31.2.111.51820: UDP, length 128
</code></pre></li>
<li>
<p>Move vpnh2 back to the original 192.168.2.0/24 subnet (inside of vpnr2). Its address was changed back from 172.31.2.111 to 192.168.2.11 and its packets went through NAT again.<br>
[host]</p>
<pre><code>sudo sh ./goback.sh
</code></pre></li>
<li>
<p>See what happens once more.<br>
Source of WireGuard packets were changed back to 172.31.2.11 but ping continued to be received responses on vpnh2.<br>
[vpnh2]</p>
<pre><code>64 bytes from 192.168.1.11: icmp_seq=1333 ttl=63 time=1.281 ms
64 bytes from 192.168.1.11: icmp_seq=1334 ttl=63 time=1.772 ms
...
</code></pre><p>[r1]</p>
<pre><code>08:30:46.419636 IP 172.31.2.111.51820 &gt; 172.31.1.11.51820: UDP, length 128
08:30:46.420342 IP 172.31.1.11.51820 &gt; 172.31.2.111.51820: UDP, length 128
08:30:47.449488 IP 172.31.2.11.60574 &gt; 172.31.1.11.51820: UDP, length 128
08:30:47.450383 IP 172.31.1.11.51820 &gt; 172.31.2.11.60574: UDP, length 128
...
</code></pre></li>
</ol>
<h2 id="caveats">Caveats</h2>
<h3 id="on-vnet-jails-wgx-cannot-be-destroyed-fixed">On VNET Jails, wgX cannot be destroyed (Fixed)</h3>
<p><em>2019-02-13:<br>
I reported this issue on FreeBSD Bugzilla. It&rsquo;s the first bug report to any OSS in my life! To be honest, it was a bit scary for a non-developer like me to submit a report about high-quality software like FreeBSD. But anyway it is now in the database.</em>
<a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=235704">https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=235704</a></p>
<p><em>2019-04-23:<br>
This issue was fixed in March and MFC to 12-STABLE and 11-STABLE.</em></p>
<p>This is true for both manual and rc.d setup but not the case in non-Jail environment.<br>
Because of this, <code>service wireguard stop</code> in a jail gets stuck when it waits for the interface to be destroyed.</p>
<p>Manually running <code>ifconfig wg0 destroy</code> fails with the following message.</p>
<pre><code>ifconfig wg0 destroy
ifconfig: SIOCIFDESTROY: Invalid argument
</code></pre><p>I found that renaming the interface from wgX to tunX lets you destroy it but this operation sometimes caused reboot on my system.</p>
<pre><code>ifconfig wg0 name tun0
ifconfig tun0 destroy
</code></pre><p>wireguard-go initially creates a tun interface then renames it to the one specified on command-line. I could workaround this can&rsquo;t-destroy problem by using tunX (e.g. tun1) as a WireGuard interface name from the beginning, but specifying tun0 failed with the following message.</p>
<pre><code>ERROR: (tun0) 2019/01/20 05:51:29 Failed to create TUN device: failed to rename tun0 to tun0: file exists
</code></pre><p>I think this can be fixed by adding a simple check to wireguard-go&rsquo;s CreateTUN() function in tun/tun_freebsd.go.</p>
<p>For the fact that wg0 cannot be destroyed in jails, I&rsquo;m not sure what the root cause is. But I noticed some weirdness in tun interface&rsquo;s unit number assignment.</p>
<p>When I created tun0 on one jail, I couldn&rsquo;t create tun0 on other jails nor the host.</p>
<pre><code>vpnr1# ifconfig tun create
tun0
---
vpnr2# ifconfig tun0 create
ifconfig: SIOCIFCREATE2: File exists
vpnr2# ifconfig tun create
tun1
---
host# ifconfig tun0 create
ifconfig: SIOCIFCREATE2: File exists
host# ifconfig tun1 create
ifconfig: SIOCIFCREATE2: File exists
host# ifconfig tun create
tun2
</code></pre><p>I wonder if it means that if_tun&rsquo;s unit number is assigned sequentially across all jails and host?<br>
As far as I know, other interface types such as lo and gif seems to have separate unit number namespace for each jail thus I can create those types of interfaces with the same name on multiple jails and host.</p>
<h3 id="kernel-panics-on-shutdown-seems-to-be-fixed-on-113-beta">Kernel panics on shutdown (Seems to be fixed on 11.3 BETA)</h3>
<p><em>2019-04-23:<br>
Workaround was implemented in WireGuard mainstream and FreeBSD ports of wireguard and wireguard-go were also updated.<br>
Occasional hang of &ldquo;wg-quick down&rdquo; was also worked around.<br>
I tested the workarounds and didn&rsquo;t see any panic nor process hang during 50000 restarts.</em><br>
<a href="https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=233955">https://bugs.freebsd.org/bugzilla/show_bug.cgi?id=233955</a></p>
<p><em>2019-04-24:<br>
Kernel fixes also came in! One is already committed to head and the other is being reviewed.</em></p>
<p><em>2019-05-29:<br>
It appears that the issue has been resolved on FreeBSD 11.3-BETA1 which incorporated recent kernel fixes. It&rsquo;s great to be able to run wireguard on upcoming RELEASE version.</em></p>
<p>There are reports that shutting down WireGuard tunnel interface causes a kernel panic. I also noticed that &ldquo;wg-quick down&rdquo; process occasionally hangs when it waits for the interface to be removed. Those issues seem to be in the kernel and WireGuard only hits them.</p>
<h3 id="rcd-script-leaves-two-processes-after-shutdown">rc.d script leaves two processes after shutdown</h3>
<p>This is not specific to jails.</p>
<p>When using /usr/local/etc/rc.d/wireguard rc.d script, two processes are left after running <code>service wireguard stop</code>. They looks like processes representing monitor_daemon() in wg-quick script.</p>
<pre><code>ps axl
UID  PID PPID CPU PRI NI   VSZ  RSS MWCHAN STAT TT     TIME COMMAND
...
  0 6805    1   0  52  0 13004 3944 wait   IJ    1  0:00.00 /usr/local/bin/bash
  0 6806 6805   0  20  0 10956 2308 sbwait IJ    1  0:00.00 route -n monitor
...
</code></pre><p>I guess this can be fixed by adding code for shutting down the processes by their PIDs to wg-quick but I&rsquo;m not sure what is the best way.</p>
<h2 id="references">References</h2>
<ul>
<li>
<p>WireGuard<br>
<a href="https://www.wireguard.com/">https://www.wireguard.com/</a></p>
</li>
<li>
<p>WireGuard for FreeBSD<br>
<a href="https://lists.freebsd.org/pipermail/freebsd-ports/2018-May/113434.html">https://lists.freebsd.org/pipermail/freebsd-ports/2018-May/113434.html</a></p>
</li>
</ul>
<h2 id="revision-history">Revision History</h2>
<ul>
<li>2019-01-20: Created</li>
<li>2019-01-26: Added &ldquo;Remote Access (Host-to-Site) Configuration&rdquo;</li>
</ul>

    </article>

    


    <ul class="pager article-pager">
      <li class="pager-newer">
          <a href="https://genneko.github.io/playing-with-bsd/networking/freebsd-wireguard-android/" data-toggle="tooltip" data-placement="top" title="WireGuard on FreeBSD Quick Look Part 2: Android Remote Access">&lt; Newer</a>
      </li>
      <li class="pager-older">
        <a href="https://genneko.github.io/playing-with-bsd/system/bootonly-install-behind-proxy/" data-toggle="tooltip" data-placement="top" title="Using FreeBSD&#39;s Bootonly Installer Behind a Proxy">Older &gt;</a>
      </li>
    </ul>
  </div>


<div class="site-footer">
  <div class="copyright">&copy; Copyright 2017 - 2020 genneko</div>
  <ul class="site-footer-items">
    <li class="site-footer-item-about"><a href="https://genneko.github.io/about/" title="About">About</a></li>
  </ul>
  <div class="powerdby">
    Powered by <a href="https://gohugo.io/">Hugo</a> and <a href="https://github.com/taikii/whiteplain">Whiteplain</a>
  </div>
</div>


</body>
</html>
